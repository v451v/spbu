"""Таблицы коэффициентов из СП 22.13330.2016."""

import warnings
from functools import lru_cache

import numpy as np

# --- Табл. 5.12 — Коэффициенты несущей способности Nγ, Nq, Nc ---

@lru_cache(maxsize=256)
def bearing_capacity_factors(phi_deg: float) -> tuple[float, float, float]:
    """Коэффициенты несущей способности Nγ, Nq, Nc.

    Nq = (1 + sinφ)/(1 - sinφ) · e^(π·tanφ)
    Nc = (Nq - 1) · cotφ
    Nγ = (Nq - 1) · tan(1.4φ)
    
    Кэшируется для ускорения повторных вызовов с одинаковым φ.
    """
    if phi_deg < 0:
        raise ValueError(f"Угол трения не может быть отрицательным: {phi_deg}")

    if phi_deg > 45.0:
        warnings.warn(
            f"φ = {phi_deg}° > 45°: значение обрезано до 45° (выход за пределы табл. 5.12)",
            UserWarning,
            stacklevel=2,
        )
    phi = np.clip(phi_deg, 0.0, 45.0)
    phi_rad = np.radians(phi)

    if phi < 0.1:
        return 0.0, 1.0, 5.14

    sin_phi = np.sin(phi_rad)
    tan_phi = np.tan(phi_rad)

    n_q = ((1.0 + sin_phi) / (1.0 - sin_phi)) * np.exp(np.pi * tan_phi)
    n_c = (n_q - 1.0) / tan_phi
    n_gamma = (n_q - 1.0) * np.tan(1.4 * phi_rad)

    return float(n_gamma), float(n_q), float(n_c)


# --- Табл. 5.5 — Коэффициенты Mγ, Mq, Mc ---

_PHI_M = np.arange(0, 46, dtype=float)

_M_GAMMA = np.array([
    0.00, 0.01, 0.03, 0.04, 0.06, 0.08, 0.10, 0.12, 0.14, 0.16, 0.18,
    0.21, 0.23, 0.26, 0.29, 0.32, 0.36, 0.39, 0.43, 0.47, 0.51,
    0.56, 0.61, 0.66, 0.72, 0.78, 0.84, 0.91, 0.98, 1.06, 1.15,
    1.24, 1.34, 1.44, 1.55, 1.68, 1.81, 1.95, 2.11, 2.28, 2.46,
    2.66, 2.88, 3.12, 3.38, 3.66
])

_M_Q = np.array([
    1.00, 1.06, 1.12, 1.18, 1.25, 1.32, 1.39, 1.47, 1.55, 1.64, 1.73,
    1.83, 1.94, 2.05, 2.17, 2.30, 2.43, 2.57, 2.73, 2.89, 3.06,
    3.24, 3.44, 3.65, 3.87, 4.11, 4.37, 4.64, 4.93, 5.25, 5.59,
    5.95, 6.34, 6.76, 7.21, 7.71, 8.24, 8.81, 9.44, 10.11, 10.85,
    11.64, 12.51, 13.46, 14.50, 15.64
])

_M_C = np.array([
    3.14, 3.23, 3.32, 3.41, 3.51, 3.61, 3.71, 3.82, 3.93, 4.05, 4.17,
    4.29, 4.42, 4.55, 4.69, 4.84, 4.99, 5.15, 5.31, 5.48, 5.66,
    5.84, 6.04, 6.24, 6.45, 6.67, 6.90, 7.14, 7.40, 7.67, 7.95,
    8.24, 8.55, 8.88, 9.22, 9.58, 9.97, 10.37, 10.80, 11.25, 11.73,
    12.24, 12.79, 13.37, 13.98, 14.64
])


@lru_cache(maxsize=256)
def resistance_factors(phi_deg: float) -> tuple[float, float, float]:
    """Коэффициенты Mγ, Mq, Mc для расчёта R.
    
    Кэшируется для ускорения повторных вызовов с одинаковым φ.
    """
    if phi_deg < 0:
        raise ValueError(f"Угол трения не может быть отрицательным: {phi_deg}")
    if phi_deg > 45.0:
        warnings.warn(
            f"φ = {phi_deg}° > 45°: значение обрезано до 45° (выход за пределы табл. 5.5)",
            UserWarning,
            stacklevel=2,
        )
    phi = np.clip(phi_deg, 0.0, 45.0)
    return (
        float(np.interp(phi, _PHI_M, _M_GAMMA)),
        float(np.interp(phi, _PHI_M, _M_Q)),
        float(np.interp(phi, _PHI_M, _M_C)),
    )


# --- Табл. 5.8 — Коэффициент α распределения напряжений ---

_XI = np.array([
    0.0, 0.4, 0.8, 1.2, 1.6, 2.0, 2.4, 2.8, 3.2, 3.6, 4.0,
    4.4, 4.8, 5.2, 5.6, 6.0, 6.4, 6.8, 7.2, 7.6, 8.0,
    8.4, 8.8, 9.2, 9.6, 10.0, 10.4, 10.8, 11.2, 11.6, 12.0
])

_ALPHA = np.array([
    1.000, 0.949, 0.756, 0.547, 0.390, 0.285, 0.214, 0.165, 0.130, 0.106, 0.087,
    0.073, 0.062, 0.053, 0.046, 0.040, 0.036, 0.032, 0.028, 0.025, 0.023,
    0.021, 0.019, 0.017, 0.016, 0.015, 0.014, 0.013, 0.012, 0.011, 0.010
])


def stress_coefficient_alpha(z: float, b: float) -> float:
    """Коэффициент α распределения напряжений (η=1)."""
    if b <= 0 or z <= 0:
        return 1.0
    return float(np.interp(2.0 * z / b, _XI, _ALPHA))
